<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Mini iFood Local | Encontre</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> <style>
        .quantity-input { width: 60px; text-align: center; }
        /* .icon-button removido */
        #share-feedback { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s ease-in-out; z-index: 1000; }
        #share-feedback.show { opacity: 1; }
        .category-button { transition: all 0.2s; }
        .category-button.active { background-color: #EF4444; color: white; }
        .product-section { margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem; }
        .product-section:first-child { border-top: none; padding-top: 0; }
        .product-section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #374151; }
        .product-item { margin-bottom: 0.75rem; /* 12px */ }
        .product-item:last-child { margin-bottom: 0; }

        /* Esconder setas input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        /* Estilo para itens do carrinho */
        #carrinho-itens div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
         #carrinho-itens button {
             background-color: #ffcccc;
             color: #cc0000;
             border: none;
             padding: 2px 6px;
             border-radius: 3px;
             cursor: pointer;
         }
         /* Estilos para a se√ß√£o de pizza inline */
         .pizza-options {
            border-top: 1px solid #e2e8f0;
            padding-top: 0.75rem; /* 12px */
            margin-top: 0.75rem; /* 12px */
         }
        .pizza-options h5 {
            font-weight: 600; /* Semibold */
            margin-bottom: 0.5rem; /* 8px */
            color: #4A5568; /* Gray-700 */
        }
        .pizza-options .space-y-1 > div {
             display: flex;
             align-items: center;
        }
         .pizza-options label {
            margin-left: 0.5rem; /* 8px */
            font-size: 0.875rem; /* 14px */
            color: #374151; /* Gray-800 */
         }
        .pizza-options input[type="radio"],
        .pizza-options input[type="checkbox"] {
            cursor: pointer;
        }
        .pizza-price {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            color: #16A34A; /* green-600 */
        }
/* Adicionado para esconder a barra de rolagem */
.hide-scrollbar {
            -ms-overflow-style: none;  /* IE e Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;  /* Safari e Chrome */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <header class="bg-red-600 text-white p-4 text-center">
        <a href="#" onclick="voltarInicio()" class="text-2xl font-bold">üçΩÔ∏è Encontre Food</a>
    </header>

    <main class="p-4 max-w-3xl mx-auto pb-24">
      <div id="categorias-lojas" class="mb-6 flex space-x-2 overflow-x-auto p-2 hide-scrollbar"> <button class="category-button active bg-gray-200 text-gray-800 py-3 px-3 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-full shadow whitespace-nowrap" onclick="filtrarLojas('Todas')">Todas</button>
        <button class="category-button bg-gray-200 text-gray-800 py-1 px-3 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-full shadow whitespace-nowrap" onclick="filtrarLojas('Lanches')">Lanches</button>
        <button class="category-button bg-gray-200 text-gray-800 py-1 px-3 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-full shadow whitespace-nowrap" onclick="filtrarLojas('Pizzarias')">Pizzarias</button>
        <button class="category-button bg-gray-200 text-gray-800 py-1 px-3 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-full shadow whitespace-nowrap" onclick="filtrarLojas('Lanchonetes')">Lanchonetes</button>
        <button class="category-button bg-gray-200 text-gray-800 py-1 px-3 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-full shadow whitespace-nowrap" onclick="filtrarLojas('Hot Dogs')">Hot Dogs</button>
    </div>

        <div id="lojas" class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
            </div>

        <div id="tela-loja" class="hidden">
            <div class="bg-white p-4 rounded shadow mb-4 relative">
                <img id="imagemLojaTela" src="" class="rounded-t-xl w-full h-40 object-cover mb-4" alt="Imagem da Loja">
                <h2 id="nomeLoja" class="text-xl font-bold"></h2>
                <p id="descLoja" class="text-sm text-gray-600"></p>
                <p class="text-sm">‚è∞ <span id="statusLoja" class="font-bold"></span></p>
                <p class="text-sm flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-gray-600"></i>
                    <span id="enderecoLoja"></span>
                </p>
                <div class="absolute top-4 right-4 flex space-x-2">
                     <button onclick="abrirMapa()" title="Ir at√© o Local" class="bg-white text-gray-700 hover:bg-red-500 hover:text-white shadow-md rounded-full w-10 h-10 flex items-center justify-center transition duration-200 text-xl">
                         <i class="fa-solid fa-map-location-dot"></i>
                     </button>
                     <button onclick="compartilharLoja()" title="Compartilhar Loja" class="bg-white text-gray-700 hover:bg-red-500 hover:text-white shadow-md rounded-full w-10 h-10 flex items-center justify-center transition duration-200 text-xl">
                         <i class="fa-solid fa-share-nodes"></i>
                     </button>
                 </div>
            </div>

            <div id="produtos" class="space-y-4 mb-4"></div>

             <div id="secao-carrinho" class="bg-white p-4 rounded shadow mb-4">
                 <h3 class="text-lg font-semibold mb-2">Seu Pedido</h3>
                 <div id="carrinho-itens" class="mb-3">
                     <p class="text-gray-500 text-center">Seu carrinho est√° vazio.</p>
                 </div>
                 <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
                 <p>Taxa de entrega: <span id="frete" class="font-medium text-orange-600">A combinar</span></p>
                 <p class="font-bold">Total (sem entrega): R$ <span id="total">0.00</span></p>
                 <button id="btnFinalizarPedido" onclick="irPagamento()" class="mt-3 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 disabled:opacity-50" disabled>‚úÖ Finalizar Pedido</button>
             </div>
        </div>

        <div id="tela-pagamento" class="hidden bg-white p-4 rounded shadow">
            <h2 class="text-lg font-bold mb-4">Finalizar Pedido</h2>
            <div class="mb-4">
                <label for="nomeCliente" class="block mb-1 font-semibold">Seu Nome:</label>
                <input type="text" id="nomeCliente" class="w-full p-2 border rounded" placeholder="Digite seu nome completo">
            </div>

            <div class="mb-4">
                <label for="enderecoCliente" class="block mb-1 font-semibold">Seu Endere√ßo Completo:</label>
                <input type="text" id="enderecoCliente" class="w-full p-2 border rounded" placeholder="Rua, N√∫mero, Bairro, Complemento, Ponto de Ref.">
            </div>

            <h3 class="text-lg font-bold mb-2">Forma de Pagamento</h3>
            <div class="space-y-3 mb-4">
                <div> <input type="radio" id="pag_dinheiro" name="pagamento" value="Dinheiro" class="form-radio"> <label for="pag_dinheiro">Dinheiro</label> </div>
                <div> <input type="radio" id="pag_refeicao" name="pagamento" value="Vale Refei√ß√£o" class="form-radio"> <label for="pag_refeicao">Vale Refei√ß√£o</label> </div>
                <div> <input type="radio" id="pag_credito" name="pagamento" value="Cr√©dito" class="form-radio"> <label for="pag_credito">Cr√©dito</label> </div>
                <div> <input type="radio" id="pag_debito" name="pagamento" value="D√©bito" class="form-radio"> <label for="pag_debito">D√©bito</label> </div>
                <div> <input type="radio" id="pag_pix" name="pagamento" value="Pix" class="form-radio"> <label for="pag_pix">Pix</label> </div>
            </div>
            <div class="mb-4">
                <label for="troco" class="block mb-1">Precisa de troco? Para quanto? (Se pagar com Dinheiro)</label>
                <input type="number" id="troco" class="w-full p-2 border rounded" value="0" min="0">
            </div>
            <div class="mb-4">
                <label for="observacao" class="block mb-1 font-semibold">Observa√ß√£o (Opcional):</label>
                <textarea id="observacao" class="w-full p-2 border rounded" rows="3" placeholder="Ex: Tirar cebola, ponto da carne, etc."></textarea>
            </div>
            <p class="text-sm text-gray-600 mb-4 bg-yellow-100 p-2 rounded">
                <strong>Aviso:</strong> N√£o cobramos taxa de servi√ßo. O valor final √© o que ser√° pago no ato da entrega ser√° apenas: (produtos + taxa de entrega a combinar).
            </p>
            <p>Total a pagar: <span class="font-bold">R$ <span id="valorFinalPagamento">0.00</span> + Taxa</span></p>
            <button onclick="enviarWhatsApp()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">üì≤ Confirmar e Enviar Pedido via WhatsApp</button>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
      <div class="flex justify-around text-center"> <button class="flex flex-col items-center justify-center p-3 text-gray-500 hover:bg-gray-50 hover:text-red-600 transition duration-150 w-1/2" onclick="voltarInicio()">
              <i class="fa-solid fa-house text-xl"></i> <span class="text-xs font-medium mt-1">In√≠cio</span> </button>

          <a href="https://encontre.vercel.app" target="_blank" class="flex flex-col items-center justify-center p-3 text-gray-500 hover:bg-gray-50 hover:text-blue-600 transition duration-150 w-1/2">
              <i class="fa-solid fa-globe text-xl"></i> <span class="text-xs font-medium mt-1">Voltar ao encontre</span>
          </a>
      </div>
  </nav>

    <div id="share-feedback">Link copiado!</div>

    <footer class="text-center text-sm text-gray-500 mt-10 p-4">
        Feito com üíö por Gui e Hiasmin no <a href="https://encontre.vercel.app" class="underline">Encontre</a>
    </footer>

    <script>
        const lojas = {
            lanchonete: {
                nome: "Lanchonete Bom Lanche",
                categoria: "Lanchonetes",
                descricao: "Os melhores lanches artesanais de S√£o Carlos!",
                endereco: "Rua Central, 123, S√£o Carlos, SP",
                imagem_loja: "https://cdn6.campograndenews.com.br/uploads/noticias/2023/01/25/44032e0d3e4dc9306b28360cadb0abade7cb5481.jpeg",
                whatsapp: "5516994392545",
                horario_abre: "18:00",
                horario_fecha: "23:30",
                produtos: {
                    "Lanches": [
                        { id: "lz_xb", nome: "combo duplo", preco: 15, imagem: "https://midias.agazeta.com.br/2023/02/13/hamburguer-da-hamburgueria-tt-burger-do-chef-thomas-troisgros-991150.jpg" },
                        { id: "lz_xs", nome: "X-Salada", preco: 17, imagem: "https://cms-blog.saipos.com/hamburguer3.jpg" }
                    ],
                    "Por√ß√µes": [
                        { id: "lz_fm1", nome: "Fritas M√©dia", preco: 8, imagem: "https://folhago.com.br/blogs/receitas-faceis/wp-content/uploads/2022/08/Batata-frita-crocante-1024x683.jpg" },
                        { id: "lz_fm2", nome: "Fritas com chedar", preco: 8, imagem: "https://receitinhas.com.br/wp-content/uploads/2017/06/Batatosa-scaled.jpg" }
                    ],
                    "Bebidas": [
                        { id: "lz_refri1", nome: "Coca-Cola", preco: 6, imagem: "https://savegnagoio.vtexassets.com/arquivos/ids/435100/REFRIGERANTECOCACOLA350MLLATA.jpg?v=638424126581970000" },
                        { id: "lz_refri2", nome: "Coca zero", preco: 6, imagem: "https://io.convertiez.com.br/m/drogaven/shop/products/images/393/medium/refrigerante-coca-cola-zero-lata-350ml_10884.jpg" }
                    ]
                }
            },
            pizzaria: {
                nome: "Pizzaria da Maria",
                categoria: "Pizzarias",
                descricao: "Sabores incr√≠veis direto do forno!",
                endereco: "Av. Principal, 456, S√£o Carlos, SP",
                imagem_loja: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/26/4a/82/50/baggio-pizzaria-moema.jpg?w=600&h=-1&s=1",
                whatsapp: "5516994392545",
                horario_abre: "17:00",
                horario_fecha: "22:00",
                produtos: {
                    "Pizzas Salgadas": [
                        {
                            id: "pm_pizza",
                            nome: "Pizza Salgada",
                            tipo: "pizza",
                            imagem: "https://invexo.com.br/blog/wp-content/uploads/2022/10/pizza-inteira-pizzaria-barra-da-tijuca-rio-de-janeiro-768x461.jpg.webp",
                            opcoes: {
                                tamanhos: [
                                    { nome: "M√©dia (6 fatias)", preco: 35.00, max_sabores: 2 },
                                    { nome: "Grande (8 fatias)", preco: 45.00, max_sabores: 3 }
                                ],
                                sabores: [
                                    { nome: "Calabresa", preco_adicional: 0 },
                                    { nome: "4 Queijos", preco_adicional: 2 },
                                    { nome: "Frango c/ Catupiry", preco_adicional: 3 },
                                    { nome: "Portuguesa", preco_adicional: 1 },
                                    { nome: "Marguerita", preco_adicional: 0 },
                                    { nome: "Pepperoni", preco_adicional: 4 }
                                ]
                            }
                        }
                    ],
                    // NOVA SE√á√ÉO: Pizzas Doces
                    "Pizzas Doces": [
                         {
                             id: "pm_pizza_doce",
                             nome: "Pizza Doce",
                             tipo: "pizza",
                             imagem: "https://anamariabrogui.com.br/assets/uploads/receitas/fotos/usuario-1932-5a1a95399763e176d63495a822004555.jpg",
                             opcoes: {
                                 tamanhos: [
                                     { nome: "Broto (4 fatias)", preco: 30.00, max_sabores: 1 },
                                     { nome: "M√©dia (6 fatias)", preco: 40.00, max_sabores: 1 }
                                 ],
                                 sabores: [
                                     { nome: "Chocolate com Morango", preco_adicional: 0 },
                                     { nome: "Romeu e Julieta", preco_adicional: 0 },
                                     { nome: "Banana com Canela", preco_adicional: 0 }
                                 ]
                             }
                         }
                    ],
                    "Bebidas": [
                        { id: "pm_refri2l1", nome: "Coca-Cola 2L", preco: 10, imagem: "https://prezunic.vtexassets.com/arquivos/ids/184447-800-auto?v=638368820890300000&width=800&height=auto&aspect=true" },
                        { id: "pm_refri2l2", nome: "Coca Zero 2L", preco: 10, imagem: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRZYEaDqlTZB4LjCHDMVv6RO8qaKbmehy3vCg&s" }
                    ]
                }
            },
           pizzaria_2: {
                nome: "La Bella Pizza",
                categoria: "Pizzarias",
                descricao: "Aut√™nticas pizzas italianas assadas no forno √† lenha.",
                endereco: "Rua It√°lia, 89, S√£o Carlos, SP",
                imagem_loja: "https://static.vecteezy.com/ti/vetor-gratis/p1/3689653-pizza-logo-vetor.jpg",
                whatsapp: "5516994392545",
                horario_abre: "18:30",
                horario_fecha: "23:45",
                produtos: {
                    "Pizzas Tradicionais": [
                        {
                            id: "lbp_pizza",
                            nome: "Pizza Especial",
                            tipo: "pizza",
                            imagem: "https://www.gov.br/turismo/pt-br/assuntos/noticias/tres-pizzarias-brasileiras-estao-entre-as-melhores-do-mundo/MTur1.png/@@images/17f74bd0-a223-4848-858c-a5cbe88fa552.png",
                            opcoes: {
                                tamanhos: [
                                    { nome: "Broto (4 fatias)", preco: 25, max_sabores: 1 },
                                    { nome: "Grande (8 fatias)", preco: 48, max_sabores: 2 }
                                ],
                                sabores: [
                                    { nome: "Napolitana", preco_adicional: 0 },
                                    { nome: "Calabresa com cebola", preco_adicional: 1 },
                                    { nome: "Br√≥colis com bacon", preco_adicional: 2 },
                                    { nome: "Palmito", preco_adicional: 1.5}
                                ]
                            }
                        }
                    ]
                }
            },
            hotdog_1: {
                nome: "Dog√£o da Esquina",
                categoria: "Hot Dogs",
                descricao: "Cachorro-quente completo e turbinado, do jeitinho brasileiro!",
                endereco: "Rua das Flores, 321, S√£o Carlos, SP",
                imagem_loja: "https://static.vecteezy.com/ti/vetor-gratis/t1/5417663-logotipo-de-designial-de-cachorro-quente-fresco-e-saboroso-vetor.jpg",
                whatsapp: "5516994392545",
                horario_abre: "17:00",
                horario_fecha: "00:00",
                produtos: {
                    "Cachorro-Quente": [
                        { id: "dog_tradicional", nome: "Dog Tradicional", preco: 10, imagem: "https://mirassolconectada.com.br/wp-content/uploads/2023/04/Imagem-do-WhatsApp-de-2023-04-17-as-15.41.31.jpg" },
                        { id: "dog_completo", nome: "Dog√£o Completo", preco: 15, imagem: "https://agendasorocaba.com.br/wp-content/uploads/2021/09/dogao-da-21-1.jpg" }
                    ]
                }
            }
        };

        let lojaAtual = null;
        let carrinho = {};
        let isSharedLink = false;

        function getBaseUrl() { return window.location.origin + window.location.pathname; }

        function filtrarLojas(categoria) {
            carregarLojas(categoria);
            document.querySelectorAll('#categorias-lojas button').forEach(btn => {
                btn.classList.remove('active', 'bg-red-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
                if (btn.textContent === categoria) {
                    btn.classList.add('active', 'bg-red-600', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-800');
                }
            });
        }

        function carregarLojas(categoria = 'Todas') {
            const containerLojas = document.getElementById("lojas");
            containerLojas.innerHTML = '';
            let count = 0;
            Object.keys(lojas).forEach(id => {
                const loja = lojas[id];
                if (categoria === 'Todas' || loja.categoria === categoria) {
                    count++;
                    const div = document.createElement("div");
                    div.className = "cursor-pointer bg-white rounded-xl shadow hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300";
                    div.onclick = () => abrirLoja(id);
                    div.innerHTML = `
                        <img src="${loja.imagem_loja}" class="rounded-t-xl w-full h-52 object-cover" alt="${loja.nome}">
                        <div class="p-4">
                            <h3 class="text-lg font-semibold">üçΩÔ∏è ${loja.nome}</h3>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${loja.categoria}</span>
                            <p class="text-sm text-gray-600 mt-1">‚≠ê 4.8 ¬∑ ${loja.horario_abre}-${loja.horario_fecha}</p>
                            <p class="text-xs mt-2 text-gray-500">${loja.descricao}</p>
                        </div>
                    `;
                    containerLojas.appendChild(div);
                }
            });
             if (count === 0) {
                 containerLojas.innerHTML = `<p class="text-center text-gray-500 col-span-1 sm:col-span-2">Nenhuma loja encontrada nesta categoria.</p>`;
             }
        }

       function lojaEstaAberta(abre, fecha) {
            const agora = new Date();
            const [horaAbre, minAbre] = abre.split(':').map(Number);
            const [horaFecha, minFecha] = fecha.split(':').map(Number);
            const dataAbre = new Date();
            dataAbre.setHours(horaAbre, minAbre, 0, 0);
            const dataFecha = new Date();
            dataFecha.setHours(horaFecha, minFecha, 0, 0);
            if (dataFecha < dataAbre) { dataFecha.setDate(dataFecha.getDate() + 1); }
            if (agora < dataAbre && agora < dataFecha && dataFecha.getDate() > dataAbre.getDate()) {
                const dataAbreOntem = new Date(dataAbre);
                dataAbreOntem.setDate(dataAbreOntem.getDate() - 1);
                return agora >= dataAbreOntem && agora <= dataFecha;
            }
            return agora >= dataAbre && agora <= dataFecha;
        }

        function abrirLoja(id) {
            if (!lojas[id]) { console.error("Loja n√£o encontrada:", id); voltarInicio(); return; }
            lojaAtual = { ...lojas[id], id: id };
            carrinho = {};
            const aberta = lojaEstaAberta(lojaAtual.horario_abre, lojaAtual.horario_fecha);

            document.getElementById("imagemLojaTela").src = lojaAtual.imagem_loja;
            document.getElementById("nomeLoja").innerText = lojaAtual.nome;
            document.getElementById("descLoja").innerText = lojaAtual.descricao;
            document.getElementById("statusLoja").innerText = aberta ? "Aberto agora" : "Fechado no momento";
            document.getElementById("enderecoLoja").innerText = lojaAtual.endereco;

            const produtosDiv = document.getElementById("produtos");
            produtosDiv.innerHTML = "";

            Object.keys(lojaAtual.produtos).forEach(secaoNome => {
                const secaoDiv = document.createElement("div");
                secaoDiv.className = "product-section";
                secaoDiv.innerHTML = `<h3 class="product-section-title">${secaoNome}</h3>`;
                let pizzaItemsToUpdate = [];

                lojaAtual.produtos[secaoNome].forEach((item) => {
                    const div = document.createElement("div");

                    if (item.tipo === 'pizza') {
                         div.className = "product-item flex-col bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition mb-3";
                         div.id = `pizza-item-${item.id}`;

                         let tamanhosHTML = '';
                         item.opcoes.tamanhos.forEach((t, index) => {
                             const isChecked = index === 0 ? 'checked' : '';
                             tamanhosHTML += `
                                 <div>
                                     <input type="radio" id="tamanho-${item.id}-${index}" name="tamanho-${item.id}" value="${index}" ${isChecked}
                                            onchange="updatePizzaOptions('${item.id}')">
                                     <label for="tamanho-${item.id}-${index}">${t.nome} - R$ ${t.preco.toFixed(2)}</label>
                                 </div>
                             `;
                         });

                         let saboresHTML = '';
                         item.opcoes.sabores.forEach((s, index) => {
                             saboresHTML += `
                                 <div>
                                     <input type="checkbox" id="sabor-${item.id}-${index}" name="sabor-${item.id}" value="${index}"
                                            data-preco="${s.preco_adicional}" onchange="updatePizzaOptions('${item.id}')">
                                     <label for="sabor-${item.id}-${index}">${s.nome} (+ R$ ${s.preco_adicional.toFixed(2)})</label>
                                 </div>
                             `;
                         });

                        div.innerHTML = `
                            <div class="flex items-start space-x-4">
                                <img src="${item.imagem || 'https://via.placeholder.com/64'}" alt="${item.nome}" class="w-16 h-16 rounded object-cover border border-gray-200" />
                                <div class="flex-1">
                                    <h4 class="font-semibold">${item.nome}</h4>
                                    <p class="text-sm text-gray-500">Monte a sua!</p>
                                </div>
                                <p id="price-${item.id}" class="pizza-price">R$ 0.00</p>
                            </div>
                            <div class="pizza-options">
                                <h5>Tamanho:</h5>
                                <div id="tamanhos-${item.id}" class="space-y-1">${tamanhosHTML}</div>
                            </div>
                            <div class="pizza-options">
                                <h5>Sabores (<span id="max-sabores-${item.id}"></span>):</h5>
                                <div id="sabores-${item.id}" class="space-y-1 max-h-40 overflow-y-auto">${saboresHTML}</div>
                             </div>
                             <button onclick="adicionarPizzaConfiguradaAoCarrinho('${item.id}')" class="mt-4 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Adicionar ao Pedido</button>
                         `;
                         pizzaItemsToUpdate.push(item.id);

                    } else {
                         div.className = "product-item flex items-center bg-white rounded-lg shadow-sm p-3 space-x-4 hover:shadow-md transition mb-3";
                         div.innerHTML = `
                             <img src="${item.imagem || 'https://via.placeholder.com/64'}" alt="${item.nome}" class="w-16 h-16 rounded object-cover border border-gray-200" />
                             <div class="flex-1">
                                 <h4 class="font-semibold">${item.nome}</h4>
                                 <p class="text-sm text-gray-500">R$ ${item.preco.toFixed(2)}</p>
                             </div>
                             <div class="flex items-center">
                                 <button onclick="changeQuantity('${item.id}', -1)" class="bg-gray-200 px-2 py-1 rounded-l">-</button>
                                 <input type="number" id="qnt-${item.id}" value="0" min="0" class="quantity-input border-t border-b p-1" readonly>
                                 <button onclick="changeQuantity('${item.id}', 1)" class="bg-gray-200 px-2 py-1 rounded-r">+</button>
                             </div>
                         `;
                    }
                    secaoDiv.appendChild(div);
                });
                produtosDiv.appendChild(secaoDiv);

                pizzaItemsToUpdate.forEach(pizzaId => {
                    setTimeout(() => updatePizzaOptions(pizzaId), 0);
                });
            });

            document.getElementById("lojas").classList.add("hidden");
            document.getElementById("categorias-lojas").classList.add("hidden");
            document.getElementById("tela-loja").classList.remove("hidden");
            document.getElementById("tela-pagamento").classList.add("hidden");
            atualizarCarrinhoVisual();
            calcularTotal();
        }

        function findProductById(productId) {
            for (const secao in lojaAtual.produtos) {
                const produto = lojaAtual.produtos[secao].find(p => p.id === productId);
                if (produto) return produto;
            }
            return null;
        }

       function updatePizzaOptions(pizzaId) {
            const pizzaData = findProductById(pizzaId);
            if (!pizzaData) return 0;

            const tamanhosDiv = document.getElementById(`tamanhos-${pizzaId}`);
            const saboresDiv = document.getElementById(`sabores-${pizzaId}`);
            const selectedTamanhoInput = tamanhosDiv.querySelector('input[type="radio"]:checked');

            if (!selectedTamanhoInput) return 0;

            const tamanhoIndex = selectedTamanhoInput.value;
            const tamanho = pizzaData.opcoes.tamanhos[tamanhoIndex];
            const maxSabores = tamanho.max_sabores;

            document.getElementById(`max-sabores-${pizzaId}`).innerText = `Escolha at√© ${maxSabores} sabor(es)`;

            const checkboxes = saboresDiv.querySelectorAll('input[type="checkbox"]');
            let selecionados = 0;
            checkboxes.forEach(cb => { if (cb.checked) selecionados++; });

            checkboxes.forEach(cb => {
                cb.disabled = (selecionados >= maxSabores && !cb.checked);
            });

            // Calcular pre√ßo
            let precoTotal = tamanho.preco;
            let maiorAdicional = 0;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const adicional = parseFloat(cb.dataset.preco);
                    if (adicional > maiorAdicional) maiorAdicional = adicional;
                }
            });
            precoTotal += maiorAdicional; // L√ìGICA: Adiciona o maior valor adicional

            document.getElementById(`price-${pizzaId}`).innerText = `R$ ${precoTotal.toFixed(2)}`;
            return precoTotal;
        }

        function adicionarPizzaConfiguradaAoCarrinho(pizzaId) {
            const pizzaData = findProductById(pizzaId);
            if (!pizzaData) return;

            const tamanhoIndex = document.querySelector(`input[name="tamanho-${pizzaId}"]:checked`).value;
            const tamanho = pizzaData.opcoes.tamanhos[tamanhoIndex];
            const checkboxes = document.querySelectorAll(`#sabores-${pizzaId} input[type="checkbox"]:checked`);

            if (checkboxes.length === 0) {
                alert("Por favor, escolha pelo menos um sabor!");
                return;
            }
            if (checkboxes.length > tamanho.max_sabores) {
                alert(`Voc√™ s√≥ pode escolher at√© ${tamanho.max_sabores} sabor(es) para este tamanho.`);
                return;
            }

            let saboresNomes = [];
            checkboxes.forEach(cb => {
                const saborIndex = cb.value;
                saboresNomes.push(pizzaData.opcoes.sabores[saborIndex].nome);
            });

            const precoFinal = updatePizzaOptions(pizzaId);
            const nomePizza = `Pizza ${pizzaData.nome} ${tamanho.nome} (${saboresNomes.join(' / ')})`;
            const cartPizzaId = `pizza_${Date.now()}`;

            carrinho[cartPizzaId] = {
                nome: nomePizza,
                preco: precoFinal,
                quantidade: 1,
                tipo: 'pizza'
            };

            checkboxes.forEach(cb => cb.checked = false);
            updatePizzaOptions(pizzaId);

            atualizarCarrinhoVisual();
            calcularTotal();
             alert("Pizza adicionada ao carrinho!");
        }


        function changeQuantity(itemId, delta) {
            const input = document.getElementById(`qnt-${itemId}`);
            let currentItem = carrinho[itemId];
            if (!currentItem) {
                const produto = findProductById(itemId);
                if (produto && produto.tipo !== 'pizza' && delta > 0) {
                    carrinho[itemId] = { nome: produto.nome, preco: produto.preco, quantidade: delta, tipo: 'simples' };
                }
            } else {
                currentItem.quantidade += delta;
                if (currentItem.quantidade <= 0) { delete carrinho[itemId]; }
            }
            if (input) { input.value = carrinho[itemId] ? carrinho[itemId].quantidade : 0; }
            atualizarCarrinhoVisual();
            calcularTotal();
        }

        function removerItemCarrinho(itemId) {
            delete carrinho[itemId];
            const input = document.getElementById(`qnt-${itemId}`);
            if(input) input.value = 0;
            atualizarCarrinhoVisual();
            calcularTotal();
        }

        function atualizarCarrinhoVisual() {
            const carrinhoDiv = document.getElementById('carrinho-itens');
            carrinhoDiv.innerHTML = '';
            const isEmpty = Object.keys(carrinho).length === 0;
            if (isEmpty) {
                carrinhoDiv.innerHTML = '<p class="text-gray-500 text-center">Seu carrinho est√° vazio.</p>';
            } else {
                Object.keys(carrinho).forEach(itemId => {
                    const item = carrinho[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.innerHTML = `
                        <span>${item.quantidade}x ${item.nome} (R$ ${item.preco.toFixed(2)})</span>
                        <button onclick="removerItemCarrinho('${itemId}')">√ó</button>
                    `;
                    carrinhoDiv.appendChild(itemDiv);
                });
            }
        }

        function calcularTotal() {
            if (!lojaAtual) return;
            let subtotal = 0;
            Object.keys(carrinho).forEach(itemId => {
                subtotal += carrinho[itemId].preco * carrinho[itemId].quantidade;
            });

            document.getElementById("subtotal").innerText = subtotal.toFixed(2);
            document.getElementById("frete").innerText = "A combinar";
            document.getElementById("total").innerText = subtotal.toFixed(2);
            document.getElementById("btnFinalizarPedido").disabled = subtotal <= 0;
        }

        function irPagamento() {
            document.getElementById("valorFinalPagamento").innerText = document.getElementById("subtotal").innerText;
            document.getElementById("tela-loja").classList.add("hidden");
            document.getElementById("tela-pagamento").classList.remove("hidden");
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function enviarWhatsApp() {
            const nomeCliente = document.getElementById("nomeCliente").value.trim();
            const enderecoCliente = document.getElementById("enderecoCliente").value.trim();
            const total = document.getElementById("subtotal").innerText;
            const formaPagamentoElement = document.querySelector('input[name="pagamento"]:checked');
            const troco = document.getElementById("troco").value;
            const observacao = document.getElementById("observacao").value.trim();

            if (!nomeCliente) { alert("Por favor, digite seu nome."); document.getElementById("nomeCliente").focus(); return; }
            if (!enderecoCliente) { alert("Por favor, digite seu endere√ßo."); document.getElementById("enderecoCliente").focus(); return; }
            if (!formaPagamentoElement) { alert("Por favor, selecione uma forma de pagamento."); return; }

            const formaPagamento = formaPagamentoElement.value;
            let itensPedido = "";
            Object.keys(carrinho).forEach(itemId => {
                const item = carrinho[itemId];
                 itensPedido += `  ${item.quantidade}x ${item.nome} (R$ ${(item.preco * item.quantidade).toFixed(2)})\n`;
            });
            if (itensPedido === "") { alert("Seu carrinho est√° vazio!"); return; }

            let msg = `*Novo Pedido - ${lojaAtual.nome}*\n`;
            msg += "-------------------------\n";
            msg += `*Cliente:* ${nomeCliente}\n`;
            msg += `*Endere√ßo:* ${enderecoCliente}\n`;
            msg += "-------------------------\n";
            msg += "*Itens do Pedido:*\n";
            msg += itensPedido;
            msg += "-------------------------\n";
            if (observacao) {
                msg += `*Observa√ß√£o:* ${observacao}\n`;
                msg += "-------------------------\n";
            }
            msg += `*Subtotal:* R$ ${total}\n`;
            msg += `*Taxa de Entrega:* A combinar\n`;
            msg += `*Total:* R$ ${total} + Taxa\n`;
            msg += "-------------------------\n";
            msg += `*Forma de Pagamento:* ${formaPagamento}\n`;

            if (formaPagamento === "Dinheiro" && parseFloat(troco) > 0) {
                msg += `*Precisa de troco para:* R$ ${parseFloat(troco).toFixed(2)}\n`;
            } else if (formaPagamento === "Dinheiro") {
                 msg += `*N√£o precisa de troco.*\n`;
            }
            msg += "-------------------------\n";
            msg += "*Aviso:* Pagamento ser√° realizado na entrega.\n";

            const encoded = encodeURIComponent(msg);
            window.open(`https://wa.me/${lojaAtual.whatsapp}?text=${encoded}`, "_blank");
        }

        function voltarInicio() {
             // Sempre volta para a lista de lojas ao clicar em in√≠cio
             history.pushState(null, '', getBaseUrl()); // Limpa a URL query
             isSharedLink = false;
             document.getElementById("tela-loja").classList.add("hidden");
             document.getElementById("tela-pagamento").classList.add("hidden");
             document.getElementById("lojas").classList.remove("hidden");
             document.getElementById("categorias-lojas").classList.remove("hidden");
             lojaAtual = null;
             carrinho = {};
             filtrarLojas('Todas');
             window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function abrirMapa() {
            if(lojaAtual && lojaAtual.endereco) {
                // Tenta abrir no app Google Maps, sen√£o abre no navegador
                 const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lojaAtual.endereco)}`;
                 window.open(url, '_blank');
            }
        }

        function showShareFeedback() {
            const feedback = document.getElementById('share-feedback');
            feedback.classList.add('show');
            setTimeout(() => { feedback.classList.remove('show'); }, 2000);
        }

        function copyToClipboard(text) {
             navigator.clipboard.writeText(text).then(() => {
                 showShareFeedback();
             }).catch(err => {
                 console.error('Erro ao copiar: ', err);
                 alert('Erro ao copiar o link.');
             });
        }

        function compartilharLoja() {
            if (lojaAtual) {
                const link = `${getBaseUrl()}?loja=${lojaAtual.id}`;
                if (navigator.share) {
                    navigator.share({
                        title: `Pe√ßa em ${lojaAtual.nome}`,
                        text: `Confira os produtos de ${lojaAtual.nome} aqui!`,
                        url: link,
                    })
                    .then(() => console.log('Compartilhado com sucesso!'))
                    .catch((error) => console.log('Erro ao compartilhar:', error));
                } else {
                   copyToClipboard(link);
                }
            }
        }

        function handleURLParams() {
            const params = new URLSearchParams(window.location.search);
            const lojaId = params.get('loja');
            if (lojaId && lojas[lojaId]) {
                isSharedLink = true;
                abrirLoja(lojaId);
            } else {
                isSharedLink = false;
                filtrarLojas('Todas');
            }
        }

       document.addEventListener("DOMContentLoaded", handleURLParams);

    </script>
</body>
</html>